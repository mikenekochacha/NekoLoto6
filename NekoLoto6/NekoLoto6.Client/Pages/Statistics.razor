@page "/statistics"
@using NekoLoto6.Client.Models
@using NekoLoto6.Client.Services
@inject LotoCsvParser CsvParser

<PageTitle>ãƒ­ãƒˆ6 çµ±è¨ˆåˆ†æ</PageTitle>

<h1 class="page-title">ğŸ“Š ãƒ­ãƒˆ6 çµ±è¨ˆåˆ†æ</h1>

@if (_loading)
{
    <p class="loading-text">èª­ã¿è¾¼ã¿ä¸­...</p>
}
else if (_error is not null)
{
    <p class="error-text">ã‚¨ãƒ©ãƒ¼: @_error</p>
}
else
{
    <p class="page-subtitle">å…¨ <strong>@_totalDraws</strong> å›ã®æŠ½é¸ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æ</p>

    @* ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: å¶æ•°ãƒ»å¥‡æ•°ãƒãƒ©ãƒ³ã‚¹ *@
    <div class="card-dark">
        <h2 class="card-dark-title">å¶æ•°ãƒ»å¥‡æ•°ãƒãƒ©ãƒ³ã‚¹</h2>
        <div class="stat-chart">
            @for (var i = 0; i < _evenOdd!.Patterns.Count; i++)
            {
                var p = _evenOdd.Patterns[i];
                var isMax = i == _evenOdd.MaxIndex;
                var maxCount = _evenOdd.Patterns.Max(x => x.Count);
                var barPct = maxCount > 0 ? (double)p.Count / maxCount * 100 : 0;
                <div class="stat-row">
                    <span class="stat-label">@p.Label</span>
                    <div class="stat-bar-bg">
                        <div class="stat-bar @(isMax ? "stat-bar-highlight" : "")"
                             style="width: @barPct.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)%"></div>
                    </div>
                    <span class="stat-count">@p.Count å› (@p.Percentage.ToString("F1")%)</span>
                </div>
            }
        </div>
    </div>

    @* ã‚»ã‚¯ã‚·ãƒ§ãƒ³2: é«˜ä½ãƒãƒ©ãƒ³ã‚¹ *@
    <div class="card-dark">
        <h2 class="card-dark-title">é«˜ä½ãƒãƒ©ãƒ³ã‚¹ï¼ˆä½1-21 / é«˜22-43ï¼‰</h2>
        <div class="stat-chart">
            @for (var i = 0; i < _highLow!.Patterns.Count; i++)
            {
                var p = _highLow.Patterns[i];
                var isMax = i == _highLow.MaxIndex;
                var maxCount = _highLow.Patterns.Max(x => x.Count);
                var barPct = maxCount > 0 ? (double)p.Count / maxCount * 100 : 0;
                <div class="stat-row">
                    <span class="stat-label">@p.Label</span>
                    <div class="stat-bar-bg">
                        <div class="stat-bar @(isMax ? "stat-bar-highlight" : "")"
                             style="width: @barPct.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)%"></div>
                    </div>
                    <span class="stat-count">@p.Count å› (@p.Percentage.ToString("F1")%)</span>
                </div>
            }
        </div>
    </div>

    @* ã‚»ã‚¯ã‚·ãƒ§ãƒ³3: åˆè¨ˆå€¤ã®åˆ†å¸ƒ *@
    <div class="card-dark">
        <h2 class="card-dark-title">æœ¬æ•°å­— åˆè¨ˆå€¤ã®åˆ†å¸ƒ</h2>
        <div class="stat-summary">
            <span>å¹³å‡: <strong>@_sumRange!.Average.ToString("F1")</strong></span>
            <span>ä¸­å¤®å€¤: <strong>@_sumRange.Median.ToString("F1")</strong></span>
            <span>æœ€å°: <strong>@_sumRange.Min</strong></span>
            <span>æœ€å¤§: <strong>@_sumRange.Max</strong></span>
        </div>
        <div class="stat-chart">
            @{
                var sumMaxCount = _sumRange.Ranges.Max(x => x.Count);
            }
            @foreach (var p in _sumRange.Ranges)
            {
                var barPct = sumMaxCount > 0 ? (double)p.Count / sumMaxCount * 100 : 0;
                <div class="stat-row">
                    <span class="stat-label stat-label-wide">@p.Label</span>
                    <div class="stat-bar-bg">
                        <div class="stat-bar" style="width: @barPct.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)%"></div>
                    </div>
                    <span class="stat-count">@p.Count å› (@p.Percentage.ToString("F1")%)</span>
                </div>
            }
        </div>
    </div>

    @* ã‚»ã‚¯ã‚·ãƒ§ãƒ³4: é€£ç•ªåˆ†æ *@
    <div class="card-dark">
        <h2 class="card-dark-title">é€£ç•ªï¼ˆé€£ç¶šæ•°å­—ï¼‰ã®å‡ºç¾åˆ†æ</h2>
        <p class="stat-note">é€£ç•ªã¨ã¯ã€éš£ã‚Šåˆã†æ•°å­—ï¼ˆä¾‹: 5,6 ã‚„ 12,13,14ï¼‰ã®ã“ã¨ã§ã™</p>
        <div class="stat-chart">
            @for (var i = 0; i < _consecutive!.Patterns.Count; i++)
            {
                var p = _consecutive.Patterns[i];
                var isMax = i == _consecutive.MaxIndex;
                var maxCount = _consecutive.Patterns.Max(x => x.Count);
                var barPct = maxCount > 0 ? (double)p.Count / maxCount * 100 : 0;
                <div class="stat-row">
                    <span class="stat-label">@p.Label</span>
                    <div class="stat-bar-bg">
                        <div class="stat-bar @(isMax ? "stat-bar-highlight" : "")"
                             style="width: @barPct.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)%"></div>
                    </div>
                    <span class="stat-count">@p.Count å› (@p.Percentage.ToString("F1")%)</span>
                </div>
            }
        </div>
    </div>
}

@code {
    private bool _loading = true;
    private string? _error;
    private int _totalDraws;
    private EvenOddResult? _evenOdd;
    private HighLowResult? _highLow;
    private SumRangeResult? _sumRange;
    private ConsecutiveResult? _consecutive;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var results = await CsvParser.LoadResultsAsync();
            _totalDraws = results.Count;

            _evenOdd = LotoStatisticsService.AnalyzeEvenOdd(results);
            _highLow = LotoStatisticsService.AnalyzeHighLow(results);
            _sumRange = LotoStatisticsService.AnalyzeSumDistribution(results);
            _consecutive = LotoStatisticsService.AnalyzeConsecutive(results);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }
}
