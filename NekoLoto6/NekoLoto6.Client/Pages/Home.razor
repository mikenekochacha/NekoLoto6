@page "/"
@using NekoLoto6.Client.Models
@using NekoLoto6.Client.Services
@inject LotoCsvParser CsvParser

<PageTitle>NekoLoto6 - 出現回数分析</PageTitle>

<h1>ロト6 出現回数分析</h1>

@if (_loading)
{
    <p>読み込み中...</p>
}
else if (_error is not null)
{
    <p style="color: red;">エラー: @_error</p>
}
else
{
    <p>全 <strong>@_totalDraws</strong> 回の抽選データを分析</p>

    <h2>番号別 出現回数（本数字）</h2>

    <div class="frequency-chart">
        @for (var num = 1; num <= 43; num++)
        {
            var count = _frequency[num];
            var pct = _maxCount > 0 ? (double)count / _maxCount * 100 : 0;
            <div class="freq-row">
                <span class="freq-label">@num.ToString("D2")</span>
                <div class="freq-bar-bg">
                    <div class="freq-bar" style="width: @pct.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)%"></div>
                </div>
                <span class="freq-count">@count 回</span>
            </div>
        }
    </div>
}

<style>
    .frequency-chart {
        max-width: 700px;
    }

    .freq-row {
        display: flex;
        align-items: center;
        margin-bottom: 2px;
        height: 24px;
    }

    .freq-label {
        width: 30px;
        font-weight: bold;
        text-align: right;
        margin-right: 8px;
        font-size: 14px;
    }

    .freq-bar-bg {
        flex: 1;
        background-color: #e9ecef;
        border-radius: 4px;
        height: 18px;
        overflow: hidden;
    }

    .freq-bar {
        height: 100%;
        background-color: #0d6efd;
        border-radius: 4px;
        min-width: 2px;
        transition: width 0.3s ease;
    }

    .freq-count {
        width: 70px;
        text-align: right;
        font-size: 13px;
        margin-left: 8px;
        color: #555;
    }
</style>

@code {
    private bool _loading = true;
    private string? _error;
    private int _totalDraws;
    private int[] _frequency = new int[44]; // index 1〜43 を使用
    private int _maxCount;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var results = await CsvParser.LoadResultsAsync();
            _totalDraws = results.Count;

            foreach (var result in results)
            {
                foreach (var num in result.MainNumbers)
                {
                    if (num >= 1 && num <= 43)
                        _frequency[num]++;
                }
            }

            _maxCount = _frequency.Skip(1).Max();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }
}
