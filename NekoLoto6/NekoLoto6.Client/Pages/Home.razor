@page "/"
@using NekoLoto6.Client.Models
@using NekoLoto6.Client.Services
@inject LotoCsvParser CsvParser

<PageTitle>NekoLoto6 - æ¬¡å›äºˆæƒ³</PageTitle>

<img src="images/neko-mascot.png" class="neko-avatar-large" alt="NekoLoto6" />
<h1 class="page-title">ğŸ¯ NekoLoto6 æ¬¡å›äºˆæƒ³</h1>

@if (_loading)
{
    <p class="loading-text">èª­ã¿è¾¼ã¿ä¸­...</p>
}
else if (_error is not null)
{
    <p class="error-text">ã‚¨ãƒ©ãƒ¼: @_error</p>
}
else
{
    <p class="page-subtitle">å…¨ <strong>@_prediction!.TotalDraws</strong> å›ã®æŠ½é¸ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãçµ±è¨ˆåˆ†æäºˆæƒ³</p>

    @* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰: ãŠã™ã™ã‚6æ•°å­— *@
    <div class="card-dark predict-main-card">
        <h2 class="card-dark-title">ãŠã™ã™ã‚6æ•°å­—</h2>
        <div class="predict-balls">
            @foreach (var num in _prediction.RecommendedNumbers)
            {
                <span class="predict-ball">@num.ToString("D2")</span>
            }
        </div>
        <p class="predict-note">â€» çµ±è¨ˆçš„å‚¾å‘ã«åŸºã¥ãå‚è€ƒå€¤ã§ã™ã€‚å½“é¸ã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    </div>

    @* é¸å®šç†ç”±ã‚«ãƒ¼ãƒ‰ *@
    <div class="card-dark">
        <h2 class="card-dark-title">é¸å®šç†ç”±</h2>
        @foreach (var num in _prediction.RecommendedNumbers)
        {
            var score = _prediction.AllScores.First(s => s.Number == num);
            <div class="predict-reason-row">
                <span class="num-badge">@num.ToString("D2")</span>
                <span class="predict-reason-text">@LotoPredictionService.GetReasonText(score)</span>
            </div>
        }
    </div>

    @* æ ¹æ‹ ã‚«ãƒ¼ãƒ‰: ã‚¹ã‚³ã‚¢è©³ç´° *@
    <div class="card-dark">
        <h2 class="card-dark-title">é¸å‡ºæ ¹æ‹  ã‚¹ã‚³ã‚¢è©³ç´°</h2>
        @foreach (var num in _prediction.RecommendedNumbers)
        {
            var score = _prediction.AllScores.First(s => s.Number == num);
            <div class="predict-detail">
                <div class="predict-detail-header">
                    <span class="num-badge">@num.ToString("D2")</span>
                    <span class="predict-detail-total">åˆè¨ˆã‚¹ã‚³ã‚¢: <strong>@score.TotalScore.ToString("F3")</strong></span>
                </div>
                <div class="predict-score-bars">
                    <div class="predict-score-row">
                        <span class="predict-score-label">å‡ºç¾é »åº¦ (20%)</span>
                        <div class="predict-score-bar-bg">
                            <div class="predict-score-bar" style="width: @((score.FrequencyScore * 100).ToString("F1", System.Globalization.CultureInfo.InvariantCulture))%"></div>
                        </div>
                        <span class="predict-score-value">@score.FrequencyScore.ToString("F2")</span>
                    </div>
                    <div class="predict-score-row">
                        <span class="predict-score-label">ç›´è¿‘ãƒˆãƒ¬ãƒ³ãƒ‰ (30%)</span>
                        <div class="predict-score-bar-bg">
                            <div class="predict-score-bar predict-score-bar-trend" style="width: @((score.TrendScore * 100).ToString("F1", System.Globalization.CultureInfo.InvariantCulture))%"></div>
                        </div>
                        <span class="predict-score-value">@score.TrendScore.ToString("F2")</span>
                    </div>
                    <div class="predict-score-row">
                        <span class="predict-score-label">å‡ºç›®é–“éš” (20%)</span>
                        <div class="predict-score-bar-bg">
                            <div class="predict-score-bar predict-score-bar-interval" style="width: @((score.IntervalScore * 100).ToString("F1", System.Globalization.CultureInfo.InvariantCulture))%"></div>
                        </div>
                        <span class="predict-score-value">@score.IntervalScore.ToString("F2")</span>
                    </div>
                    <div class="predict-score-row">
                        <span class="predict-score-label">ãƒãƒ©ãƒ³ã‚¹ (10%)</span>
                        <div class="predict-score-bar-bg">
                            <div class="predict-score-bar predict-score-bar-balance" style="width: @((score.BalanceScore * 100).ToString("F1", System.Globalization.CultureInfo.InvariantCulture))%"></div>
                        </div>
                        <span class="predict-score-value">@score.BalanceScore.ToString("F2")</span>
                    </div>
                    <div class="predict-score-row">
                        <span class="predict-score-label">å¼•ãç¶™ãå‚¾å‘ (20%)</span>
                        <div class="predict-score-bar-bg">
                            <div class="predict-score-bar predict-score-bar-carryover" style="width: @((score.CarryoverScore * 100).ToString("F1", System.Globalization.CultureInfo.InvariantCulture))%"></div>
                        </div>
                        <span class="predict-score-value">@score.CarryoverScore.ToString("F2")</span>
                    </div>
                </div>
                <p class="predict-detail-info">
                    å…¨æœŸé–“ @score.TotalAppearances å›å‡ºç¾ / ç›´è¿‘@(_prediction.RecentDraws)å›ã§ @score.RecentAppearances å›å‡ºç¾ / æœ€å¾Œã®å‡ºç¾ã‹ã‚‰ @score.DrawsSinceLastAppearance å›å‰@(score.IsCarriedOver ? " / å‰å›ã‹ã‚‰å¼•ãç¶™ã" : "")
                </p>
            </div>
        }
    </div>

    @* ã‚¹ã‚³ã‚¢ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰ *@
    <div class="card-dark">
        <details>
            <summary class="card-dark-title predict-ranking-summary">å…¨43æ•°å­— ã‚¹ã‚³ã‚¢ãƒ©ãƒ³ã‚­ãƒ³ã‚°</summary>
            <div class="predict-ranking">
                @{ var rank = 1; }
                @foreach (var score in _prediction.AllScores)
                {
                    var isSelected = _prediction.RecommendedNumbers.Contains(score.Number);
                    <div class="predict-ranking-row @(isSelected ? "predict-ranking-highlight" : "")">
                        <span class="predict-ranking-rank">@rank</span>
                        <span class="num-badge @(isSelected ? "" : "num-badge-dim")">@score.Number.ToString("D2")</span>
                        <div class="predict-score-bar-bg predict-ranking-bar">
                            <div class="predict-score-bar" style="width: @((score.TotalScore / _prediction.AllScores[0].TotalScore * 100).ToString("F1", System.Globalization.CultureInfo.InvariantCulture))%"></div>
                        </div>
                        <span class="predict-ranking-score">@score.TotalScore.ToString("F3")</span>
                    </div>
                    rank++;
                }
            </div>
        </details>
    </div>
}

@code {
    private bool _loading = true;
    private string? _error;
    private PredictionResult? _prediction;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var results = await CsvParser.LoadResultsAsync();
            _prediction = LotoPredictionService.GeneratePrediction(results);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }
}
