@page "/"
@using System.Text.Json
@using NekoLoto6.Client.Models
@inject HttpClient Http

<PageTitle>NekoLoto6 - æ¬¡å›äºˆæƒ³</PageTitle>

<img src="images/neko-mascot.png" class="neko-avatar-large" alt="NekoLoto6" />
<h1 class="page-title">ğŸ¯ NekoLoto6 æ¬¡å›äºˆæƒ³</h1>

@if (_loading)
{
    <p class="loading-text">èª­ã¿è¾¼ã¿ä¸­...</p>
}
else if (_error is not null)
{
    <p class="error-text">ã‚¨ãƒ©ãƒ¼: @_error</p>
}
else
{
    <p class="page-subtitle">å…¨ <strong>@_data!.TotalDrawings</strong> å›ã®æŠ½é¸ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãçµ±è¨ˆåˆ†æäºˆæƒ³</p>

    @* æœ€æ–°æŠ½é¸æƒ…å ± & æ›´æ–°æ—¥æ™‚ *@
    <div class="predict-meta">
        <span>æœ€æ–°: ç¬¬@(_data.LatestDrawing.Round)å› (@_data.LatestDrawing.Date)
            ã€@(string.Join(" ", _data.LatestDrawing.Numbers.Select(n => n.ToString("D2")))) + bonus @_data.LatestDrawing.Bonus.ToString("D2")ã€‘</span>
        <span>æ›´æ–°: @FormatLastUpdated(_data.LastUpdated)</span>
    </div>

    @* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰: ãŠã™ã™ã‚6æ•°å­— *@
    <div class="card-dark predict-main-card">
        <h2 class="card-dark-title">ãŠã™ã™ã‚6æ•°å­—</h2>
        <div class="predict-balls">
            @foreach (var num in _data.Recommendation.Numbers)
            {
                <span class="predict-ball">@num.ToString("D2")</span>
            }
        </div>
        <p class="predict-note">â€» çµ±è¨ˆçš„å‚¾å‘ã«åŸºã¥ãå‚è€ƒå€¤ã§ã™ã€‚å½“é¸ã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    </div>

    @* é¸å®šç†ç”±ã‚«ãƒ¼ãƒ‰ *@
    <div class="card-dark">
        <h2 class="card-dark-title">é¸å®šç†ç”±</h2>
        @foreach (var num in _data.Recommendation.Numbers)
        {
            var rscore = _data.Recommendation.Scores[num.ToString()];
            <div class="predict-reason-row">
                <span class="num-badge">@num.ToString("D2")</span>
                <span class="predict-reason-arrow">â†’</span>
                <span class="predict-reason-text">@_reasons[num]</span>
            </div>
        }
    </div>

    @* æ ¹æ‹ ã‚«ãƒ¼ãƒ‰: ã‚¹ã‚³ã‚¢è©³ç´° *@
    <div class="card-dark">
        <h2 class="card-dark-title">é¸å‡ºæ ¹æ‹  ã‚¹ã‚³ã‚¢è©³ç´°</h2>
        @foreach (var num in _data.Recommendation.Numbers)
        {
            var rscore = _data.Recommendation.Scores[num.ToString()];
            var detail = _data.AllScores.FirstOrDefault(s => s.Number == num);
            <div class="predict-detail">
                <div class="predict-detail-header">
                    <span class="num-badge">@num.ToString("D2")</span>
                    <span class="predict-detail-total">åˆè¨ˆã‚¹ã‚³ã‚¢: <strong>@rscore.Total.ToString("F3")</strong></span>
                </div>
                <div class="predict-score-bars">
                    <div class="predict-score-row">
                        <span class="predict-score-label">å‡ºç¾é »åº¦ (20%)</span>
                        <div class="predict-score-bar-bg">
                            <div class="predict-score-bar" style="width: @((rscore.Frequency * 100).ToString("F1", System.Globalization.CultureInfo.InvariantCulture))%"></div>
                        </div>
                        <span class="predict-score-value">@rscore.Frequency.ToString("F2")</span>
                    </div>
                    <div class="predict-score-row">
                        <span class="predict-score-label">ç›´è¿‘ãƒˆãƒ¬ãƒ³ãƒ‰ (30%)</span>
                        <div class="predict-score-bar-bg">
                            <div class="predict-score-bar predict-score-bar-trend" style="width: @((rscore.Trend * 100).ToString("F1", System.Globalization.CultureInfo.InvariantCulture))%"></div>
                        </div>
                        <span class="predict-score-value">@rscore.Trend.ToString("F2")</span>
                    </div>
                    <div class="predict-score-row">
                        <span class="predict-score-label">å‡ºç›®é–“éš” (20%)</span>
                        <div class="predict-score-bar-bg">
                            <div class="predict-score-bar predict-score-bar-interval" style="width: @((rscore.Interval * 100).ToString("F1", System.Globalization.CultureInfo.InvariantCulture))%"></div>
                        </div>
                        <span class="predict-score-value">@rscore.Interval.ToString("F2")</span>
                    </div>
                    <div class="predict-score-row">
                        <span class="predict-score-label">ãƒãƒ©ãƒ³ã‚¹ (10%)</span>
                        <div class="predict-score-bar-bg">
                            <div class="predict-score-bar predict-score-bar-balance" style="width: @((rscore.Balance * 100).ToString("F1", System.Globalization.CultureInfo.InvariantCulture))%"></div>
                        </div>
                        <span class="predict-score-value">@rscore.Balance.ToString("F2")</span>
                    </div>
                    <div class="predict-score-row">
                        <span class="predict-score-label">å¼•ãç¶™ãå‚¾å‘ (20%)</span>
                        <div class="predict-score-bar-bg">
                            <div class="predict-score-bar predict-score-bar-carryover" style="width: @((rscore.Carryover * 100).ToString("F1", System.Globalization.CultureInfo.InvariantCulture))%"></div>
                        </div>
                        <span class="predict-score-value">@rscore.Carryover.ToString("F2")</span>
                    </div>
                </div>
                @if (detail is not null)
                {
                    <p class="predict-detail-info">
                        å…¨æœŸé–“ @detail.TotalAppearances å›å‡ºç¾ / ç›´è¿‘@(_data.RecentDraws)å›ã§ @detail.RecentAppearances å›å‡ºç¾ / æœ€å¾Œã®å‡ºç¾ã‹ã‚‰ @detail.DrawsSinceLastAppearance å›å‰@(detail.IsCarriedOver ? " / å‰å›ã‹ã‚‰å¼•ãç¶™ã" : "")
                    </p>
                }
            </div>
        }
    </div>

    @* ã‚¹ã‚³ã‚¢ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰ *@
    <div class="card-dark">
        <details>
            <summary class="card-dark-title predict-ranking-summary">å…¨43æ•°å­— ã‚¹ã‚³ã‚¢ãƒ©ãƒ³ã‚­ãƒ³ã‚°</summary>
            <div class="predict-ranking">
                @{ var rank = 1; }
                @foreach (var score in _data.AllScores)
                {
                    var isSelected = _data.Recommendation.Numbers.Contains(score.Number);
                    <div class="predict-ranking-row @(isSelected ? "predict-ranking-highlight" : "")">
                        <span class="predict-ranking-rank">@rank</span>
                        <span class="num-badge @(isSelected ? "" : "num-badge-dim")">@score.Number.ToString("D2")</span>
                        <div class="predict-score-bar-bg predict-ranking-bar">
                            <div class="predict-score-bar" style="width: @((_data.AllScores[0].TotalScore > 0 ? score.TotalScore / _data.AllScores[0].TotalScore * 100 : 0).ToString("F1", System.Globalization.CultureInfo.InvariantCulture))%"></div>
                        </div>
                        <span class="predict-ranking-score">@score.TotalScore.ToString("F3")</span>
                    </div>
                    rank++;
                }
            </div>
        </details>
    </div>
}

@code {
    private static readonly JsonSerializerOptions _jsonOptions = new()
    {
        PropertyNameCaseInsensitive = true
    };

    private bool _loading = true;
    private string? _error;
    private PredictionData? _data;
    private Dictionary<int, string> _reasons = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _data = await Http.GetFromJsonAsync<PredictionData>("data/prediction.json", _jsonOptions);
            if (_data is null)
                _error = "äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
            else
                _reasons = GenerateUniqueReasons(_data.Recommendation);
        }
        catch (HttpRequestException)
        {
            _error = "äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚GitHub Actionsã§ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚";
        }
        catch (Exception ex)
        {
            _error = $"äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {ex.Message}";
        }
        finally
        {
            _loading = false;
        }
    }

    private static string FormatLastUpdated(string isoDate)
    {
        if (DateTimeOffset.TryParse(isoDate, out var dto))
            return dto.ToString("yyyy/MM/dd HH:mm");
        return isoDate;
    }

    private static Dictionary<int, string> GenerateUniqueReasons(RecommendationData rec)
    {
        var result = new Dictionary<int, string>();
        var used = new HashSet<string>();

        foreach (var num in rec.Numbers)
        {
            var s = rec.Scores[num.ToString()];
            var candidates = GetReasonCandidates(s);
            var text = candidates.FirstOrDefault(c => !used.Contains(c)) ?? candidates[0];
            result[num] = text;
            used.Add(text);
        }

        return result;
    }

    private static List<string> GetReasonCandidates(RecommendedScoreData s)
    {
        var candidates = new List<string>();
        var indicators = new (string key, double value)[]
        {
            ("frequency", s.Frequency),
            ("trend", s.Trend),
            ("interval", s.Interval),
            ("balance", s.Balance),
            ("carryover", s.Carryover)
        };
        var sorted = indicators.OrderByDescending(x => x.value).ToArray();

        // Priority 1: Combo (top + second) if second >= 0.7
        if (sorted[1].value >= 0.7)
            candidates.AddRange(GetComboTexts(sorted[0].key, sorted[1].key));

        // Priority 2: Single variants for top indicator
        candidates.AddRange(GetSingleTexts(sorted[0].key));

        // Priority 3: Combo (top + third) if third >= 0.7
        if (sorted[2].value >= 0.7)
            candidates.AddRange(GetComboTexts(sorted[0].key, sorted[2].key));

        // Priority 4: Single variants for second indicator
        candidates.AddRange(GetSingleTexts(sorted[1].key));

        // Priority 5: Single variants for remaining indicators
        for (var i = 2; i < sorted.Length; i++)
            candidates.AddRange(GetSingleTexts(sorted[i].key));

        return candidates;
    }

    private static string[] GetSingleTexts(string indicator) => indicator switch
    {
        "frequency" => new[]
        {
            "å…¨æœŸé–“ã§ã®å‡ºç¾ç‡ãŒé«˜ãã€å®‰å®šã—ãŸæ•°å­—",
            "å…¨æœŸé–“ã‚’é€šã˜ã¦å®‰å®šæ„Ÿã®ã‚ã‚‹æ•°å­—",
            "é•·æœŸçš„ã«è¦‹ã¦ä¿¡é ¼åº¦ã®é«˜ã„æ•°å­—"
        },
        "trend" => new[]
        {
            "ç›´è¿‘50å›ã§ç‰¹ã«å‹¢ã„ãŒã‚ã‚‹æ³¨ç›®æ•°å­—",
            "æœ€è¿‘ã®æŠ½é¸ã§å¥½èª¿ãªæ•°å­—",
            "ã“ã“æœ€è¿‘ã®å‡ºç¾ç‡ãŒä¸Šæ˜‡ä¸­"
        },
        "interval" => new[]
        {
            "ã—ã°ã‚‰ãå‡ºã¦ã„ãªã„ãŸã‚ã€ãã‚ãã‚å‡ºã‚‹å¯èƒ½æ€§",
            "å‡ºç›®é–“éš”ãŒåºƒãŒã£ã¦ãŠã‚Šã€åç™ºã«æœŸå¾…",
            "å‰å›ã‹ã‚‰é–“ãŒç©ºã„ã¦ãŠã‚Šã€å‡ºç¾ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‹"
        },
        "balance" => new[]
        {
            "ãƒãƒ©ãƒ³ã‚¹ãŒéå¸¸ã«è‰¯ãã€ç·åˆåŠ›ãŒé«˜ã„æ•°å­—",
            "å„æŒ‡æ¨™ãŒã¾ã‚“ã¹ã‚“ãªãé«˜ã„å„ªç­‰ç”Ÿã‚¿ã‚¤ãƒ—",
            "åã‚ŠãŒå°‘ãªãã€å®‰å®šã—ãŸç·åˆè©•ä¾¡"
        },
        "carryover" => new[]
        {
            "å‰å›ã‚‚å‡ºç¾ã—ã¦ãŠã‚Šã€å¼•ãç¶™ãŒã‚Œã‚„ã™ã„å‚¾å‘ã®æ•°å­—",
            "é€£ç¶šå‡ºç¾ã®å¯èƒ½æ€§ãŒçµ±è¨ˆçš„ã«é«˜ã„æ•°å­—",
            "å‰å›ã®æµã‚Œã‚’å¼•ãç¶™ãå‹¢ã„ã®ã‚ã‚‹æ•°å­—"
        },
        _ => Array.Empty<string>()
    };

    private static string[] GetComboTexts(string a, string b) => (a, b) switch
    {
        ("trend", "frequency") or ("frequency", "trend") => new[]
        {
            "ç›´è¿‘50å›ã§å‹¢ã„ãŒã‚ã‚Šã€å…¨æœŸé–“ã§ã‚‚å®‰å®šã—ã¦å‡ºç¾",
            "æœ€è¿‘ã®å¥½èª¿ã•ã«åŠ ãˆã€é•·æœŸçš„ãªå®‰å®šæ„Ÿã‚‚å…¼å‚™"
        },
        ("trend", "interval") or ("interval", "trend") => new[]
        {
            "ç›´è¿‘ã®å‹¢ã„ãŒã‚ã‚Šã€å‡ºç›®é–“éš”çš„ã«ã‚‚å¥½ã‚¿ã‚¤ãƒŸãƒ³ã‚°",
            "æœ€è¿‘ã®å¥½èª¿ã¨å‡ºç›®é–“éš”ã®å¥½æ¡ä»¶ãŒé‡ãªã‚‹æ•°å­—"
        },
        ("frequency", "interval") or ("interval", "frequency") => new[]
        {
            "å®‰å®šã—ãŸå‡ºç¾ç‡ã§ã€å‡ºç›®é–“éš”çš„ã«ã‚‚æœŸå¾…å¤§",
            "é«˜ã„å‡ºç¾ç‡ã«åŠ ãˆã€é–“éš”çš„ã«ã‚‚å¥½ã‚¿ã‚¤ãƒŸãƒ³ã‚°"
        },
        ("frequency", "balance") or ("balance", "frequency") => new[]
        {
            "å…¨æœŸé–“ã§å®‰å®šã—ã¦ãŠã‚Šã€ãƒãƒ©ãƒ³ã‚¹ã«ã‚‚å„ªã‚ŒãŸæ•°å­—",
            "å‡ºç¾ç‡ã®é«˜ã•ã¨ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã•ã‚’å…¼å‚™"
        },
        ("trend", "balance") or ("balance", "trend") => new[]
        {
            "ç›´è¿‘ã®å‹¢ã„ã¨ãƒãƒ©ãƒ³ã‚¹ã‚’å…¼ã­å‚™ãˆãŸæ•°å­—",
            "æœ€è¿‘å¥½èª¿ã§ãƒãƒ©ãƒ³ã‚¹ã‚‚è‰¯ã„æœŸå¾…ã®æ•°å­—"
        },
        ("interval", "balance") or ("balance", "interval") => new[]
        {
            "ã—ã°ã‚‰ãå‡ºã¦ã„ãªã„ãŒã€ãƒãƒ©ãƒ³ã‚¹ãŒè‰¯ãåç™ºãŒæœŸå¾…ã•ã‚Œã‚‹",
            "å‡ºç›®é–“éš”ã¨ãƒãƒ©ãƒ³ã‚¹ã®ä¸¡é¢ã§æœŸå¾…ã§ãã‚‹æ•°å­—"
        },
        ("carryover", "trend") or ("trend", "carryover") => new[]
        {
            "å‰å›ã‹ã‚‰ã®å¼•ãç¶™ãã§ã€ç›´è¿‘ã®å‹¢ã„ã‚‚ç¶™ç¶šä¸­",
            "é€£ç¶šå‡ºç¾ã®å‹¢ã„ã¨æœ€è¿‘ã®å¥½èª¿ã•ãŒé‡ãªã‚‹æ•°å­—"
        },
        ("carryover", "frequency") or ("frequency", "carryover") => new[]
        {
            "å‰å›ã‹ã‚‰å¼•ãç¶™ãŒã‚Œã‚„ã™ãã€å…¨æœŸé–“ã§ã‚‚å®‰å®šã—ãŸæ•°å­—",
            "å¼•ãç¶™ãå‚¾å‘ã¨é•·æœŸçš„ãªå®‰å®šæ€§ã‚’å…¼å‚™"
        },
        ("carryover", "interval") or ("interval", "carryover") => new[]
        {
            "å‰å›ã‹ã‚‰ã®å¼•ãç¶™ãã¨å‡ºç›®é–“éš”ã®ä¸¡é¢ã§æœŸå¾…å¤§",
            "å¼•ãç¶™ãã®æµã‚Œã«åŠ ãˆã€é–“éš”çš„ã«ã‚‚å‡ºã‚„ã™ã„çŠ¶æ³"
        },
        ("carryover", "balance") or ("balance", "carryover") => new[]
        {
            "å‰å›ã‹ã‚‰ã®å¼•ãç¶™ãå‚¾å‘ã¨ãƒãƒ©ãƒ³ã‚¹ã‚’å…¼å‚™",
            "é€£ç¶šå‡ºç¾ã®å¯èƒ½æ€§ãŒé«˜ãã€ãƒãƒ©ãƒ³ã‚¹ã‚‚è‰¯å¥½"
        },
        _ => Array.Empty<string>()
    };
}
