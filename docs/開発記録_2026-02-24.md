# NekoLoto6 開発記録 — 2026年2月24日

## 概要

予測アルゴリズムの改善、ブックウィジェットの拡充、本の履歴ページ新規作成、ワークフロー修正。

---

## 予測アルゴリズム改善（2026-02-24）

### 検証結果

#### 持ち越し率の検証（全2,077ペア）

LOTO6_ALL.csv の全2,078回分のデータを使い、連続する抽選回で「前回の当選番号6個のうち、少なくとも1個が次回の当選番号に含まれる確率」を計算した。

| 一致数 | 回数 | 実測 | 理論値（超幾何分布） | 差 |
|--------|------|------|----------------------|------|
| 0個 | 753回 | 36.25% | 38.13% | -1.88pp |
| 1個 | 952回 | 45.84% | 42.90% | +2.94pp |
| 2個 | 329回 | 15.84% | 16.25% | -0.41pp |
| 3個 | 38回 | 1.83% | 2.55% | -0.72pp |
| 4個 | 5回 | 0.24% | 0.16% | +0.08pp |
| 5個 | 0回 | 0.00% | 0.00% | -0.00pp |
| 6個 | 0回 | 0.00% | 0.00% | -0.00pp |

- **少なくとも1個一致: 実測63.75% vs 理論61.87%（+1.88pp）**
- 1個一致が45.84%で最多（理論42.90%より+2.94pp高い）
- 理論値より約2ポイント高く、「前回から1個持ち越される」傾向はわずかに実測データで裏付けられるが、統計的に劇的な偏りではない

#### トレンド予測の変化シミュレーション（12パターン）

直近N回（10, 20, 30, 50）× 全体/直近比率（50/50, 70/30, 30/70）の12パターンで予測番号がどう変わるかシミュレーション。現行の頻度20%+トレンド30%=50%を「全体頻度×wAll + 直近N回頻度×wRecent」に置換し、間隔20% + バランス10% + 引継20% は固定。

最新回: 第2078回 当選番号: [1, 10, 20, 24, 30, 35]

**現行アルゴリズム（頻度20% + 直近50回トレンド30% + 間隔20% + バランス10% + 引継20%）**
予測: [10, 21, 24, 35, 37, 42]  前回からの持ち越し: 3個

| 直近N | 比率 | 予測番号 | 持越 |
|-------|------|----------|------|
| N=10 | 全体50%+直近50% | [1, 6, 10, 24, 30, 35] | 5個 |
| N=10 | 全体70%+直近30% | [6, 10, 19, 24, 30, 35] | 4個 |
| N=10 | 全体30%+直近70% | [1, 6, 10, 24, 30, 35] | 5個 |
| N=20 | 全体50%+直近50% | [6, 10, 24, 35, 37, 42] | 3個 |
| N=20 | 全体70%+直近30% | [6, 10, 21, 24, 35, 42] | 3個 |
| N=20 | 全体30%+直近70% | [1, 6, 24, 30, 35, 42] | 4個 |
| N=30 | 全体50%+直近50% | [6, 21, 24, 30, 35, 42] | 3個 |
| N=30 | 全体70%+直近30% | [6, 21, 24, 30, 35, 42] | 3個 |
| N=30 | 全体30%+直近70% | [6, 21, 24, 30, 35, 42] | 3個 |
| N=50 | 全体50%+直近50% | [10, 21, 24, 35, 37, 42] | 3個 |
| N=50 | 全体70%+直近30% | [10, 21, 24, 35, 37, 42] | 3個 |
| N=50 | 全体30%+直近70% | [10, 21, 24, 35, 37, 42] | 3個 |

12パターン中7種類のユニークな予測:
- `[1,6,10,24,30,35]` ← N=10 全体50%+直近50% / N=10 全体30%+直近70%
- `[6,10,19,24,30,35]` ← N=10 全体70%+直近30%
- `[6,10,24,35,37,42]` ← N=20 全体50%+直近50%
- `[6,10,21,24,35,42]` ← N=20 全体70%+直近30%
- `[1,6,24,30,35,42]` ← N=20 全体30%+直近70%
- `[6,21,24,30,35,42]` ← N=30（全パターン共通）
- `[10,21,24,35,37,42]` ← N=50（全パターン共通）

参考: 直近N回での出現頻度Top10:
- 直近10回: 24(5), 35(4), 6(3), 10(3), 26(3), 36(3), 1(2), 14(2), 16(2), 17(2)
- 直近20回: 24(7), 6(5), 35(5), 42(5), 2(4), 10(4), 18(4), 26(4), 28(4), 29(4)
- 直近30回: 24(8), 30(7), 42(7), 6(6), 14(6), 28(6), 35(6), 37(6), 1(5), 10(5)
- 直近50回: 37(11), 42(11), 7(10), 24(10), 35(10), 10(9), 2(8), 12(8), 14(8), 15(8)

**主な所見:**
- N=10は前回当選番号との重なりが最も大きい（4〜5個）が、短期トレンドに過度に引きずられるリスク（過学習的）
- N=30以上ではデータが十分平滑化され、比率を変えても予測番号が変わらない
- N=20がパラメータ変更に対して適度に反応し、過学習と平滑化のバランスが最も良い
- 24, 35 は全12パターンで選出されており最も安定した番号

### 変更内容

| 項目 | 変更前 | 変更後 |
|------|--------|--------|
| 直近参照回数 | 50回 | **20回** |
| スコア構成 | 頻度20% + トレンド30%（独立） | **加重平均頻度50%**（全体70% + 直近30%のブレンド） |
| 間隔 | 20% | 20%（変更なし） |
| バランス | 10% | 10%（変更なし） |
| 引き継ぎ | 20% | 20%（変更なし） |
| 持ち越し保証 | なし | **前回当選番号から最低1個を予測に含める** |
| GetReasonText | 「直近50回」 | 「直近20回」 |

### 変更理由

毎週自動更新（月・木）しても予測番号が変わらない問題を解消するため。
N=50ではデータが平滑化されすぎて、新しいデータが追加されてもスコアの順位がほとんど変動しなかった。
N=20は過学習と平滑化のバランスが最も良く、毎週のデータ追加で予測が適度に変化する設計に改善。

全体頻度70% + 直近30%の加重平均を採用することで、長期的な安定性を維持しつつ直近の変動を反映できるようにした。

持ち越し保証（EnsureCarryover）は、実測データで63.75%の確率で少なくとも1個が持ち越される事実に基づく。含まれない場合は、前回当選番号のうち最もスコアが高いものと、選出済み6個のうち最もスコアが低いものを入れ替える。

### 変更ファイル

| ファイル | 変更内容 |
|----------|----------|
| `NekoLoto6/NekoLoto6.Client/Services/LotoPredictionService.cs` | アルゴリズム全面改修（定数変更、加重平均頻度スコア導入、EnsureCarryoverメソッド追加、文言修正） |
| `docs/開発記録_2026-02-24.md` | 本記録を追加 |

---

## ワークフロー修正（2026-02-24）

### 問題

`update-book.yml` と `update-loto6.yml` がどちらも月曜 20:30 JST（`cron: '30 11 * * 1'`）に実行される。同時に起動した場合、先にpushした方が成功し、後からpushする方が `non-fast-forward` で失敗する。

### 対応

両ワークフローの「Commit and push」ステップで `git push` の前に `git pull --rebase origin main` を追加。

```yaml
git diff --staged --quiet || git commit -m "..."
git pull --rebase origin main   # ← 追加
git push
```

### 変更ファイル

| ファイル | 変更内容 |
|----------|----------|
| `.github/workflows/update-book.yml` | `git push` の前に `git pull --rebase origin main` を追加 |
| `.github/workflows/update-loto6.yml` | 同上 |

---

## ブックウィジェット拡充（2026-02-24）

### 変更内容

#### update_book.py の改修

| 項目 | 変更前 | 変更後 |
|------|--------|--------|
| comment文字数 | 80〜120文字 | **200〜250文字** |
| max_tokens | 512 | **1024** |
| dateフィールド | なし | **YYYY-MM-DD形式で自動付与** |

- `from datetime import date` を追加
- `new_book["date"] = date.today().isoformat()` で日付を自動付与
- プロンプトのcomment指定を「200〜250文字の吹き出しPOP風」に変更

#### book_history.json の再生成

既存3件のコメントを200〜250文字で再生成し、dateフィールドを追加。

| # | タイトル | 著者 | date | comment文字数 |
|---|---------|------|------|--------------|
| 1 | ファスト＆スロー（上） | ダニエル・カーネマン | 2026-02-23 | 229文字 |
| 2 | 偶然の統計学 | デイヴィッド・J・ハンド | 2026-02-23 | 233文字 |
| 3 | その数学が戦略を決める | イアン・エアーズ | 2026-02-23 | 232文字 |

### 変更ファイル

| ファイル | 変更内容 |
|----------|----------|
| `scripts/update_book.py` | comment文字数変更、max_tokens増加、dateフィールド追加 |
| `NekoLoto6/NekoLoto6.Client/wwwroot/data/book_history.json` | 3件のコメント再生成＋date追加 |
| `NekoLoto6/NekoLoto6.Client/wwwroot/data/current_book.json` | 同期更新 |

---

## 本の履歴ページ新規作成（2026-02-24）

### 概要

`books.html`（おすすめの本）ページを新規作成。`book_history.json` を読み込み、過去に紹介した書籍をカード形式で一覧表示する。

### 表示内容（新しい順）

- 本の表紙画像（Amazon Product Image）
- タイトル・著者名
- 紹介日（date）
- 書店員風コメント（comment）
- 「Amazonで見る →」リンク（アフィリエイトタグ: `nekocode-22`）

### 実装内容

#### HtmlGenerator.cs

- `GenerateBooksPage(string wwwrootDir)` メソッドを追加
  - `data/book_history.json` を `System.Text.Json` で読み込み
  - 各書籍をカード形式（`.book-card`）で出力
- `GenerateAll()` に `books.html` 生成を追加
- ナビゲーションに `("books", "books.html", "bi-book-nav-menu", "おすすめの本")` を追加
  - 全5ページ（index, frequency, statistics, algorithm, books）のサイドバーに反映
- `GenerateSitemap()` に `books.html` を追加（priority: 0.6, changefreq: weekly）
- `EscapeHtml()` ヘルパーメソッドを追加

#### app.css

- `.bi-book-nav-menu` — ナビゲーション用の本アイコン（Bootstrap Icons book SVG、#f5a623）
- `.book-card` / `.book-card-inner` — カードレイアウト（横並び flexbox）
- `.book-card-cover` / `.book-card-img` — 表紙画像（120px幅）
- `.book-card-title` — タイトル（#f5a623、太字）
- `.book-card-author` — 著者名（薄いグレー）
- `.book-card-date` — 紹介日（さらに薄いグレー）
- `.book-card-comment` — コメント本文（行間1.7）
- レスポンシブ対応: 640px以下で縦並び・中央寄せに切り替え

#### deploy.yml

`cp -a NekoLoto6/NekoLoto6.Client/wwwroot/. _site/nekoloto6/` で wwwroot 以下を丸ごとコピーしているため、`books.html` は自動的に含まれる。修正不要。

### 変更ファイル

| ファイル | 変更内容 |
|----------|----------|
| `tools/ScoreCalculator/HtmlGenerator.cs` | GenerateBooksPage追加、ナビ追加、sitemap追加、EscapeHtml追加 |
| `NekoLoto6/NekoLoto6.Client/wwwroot/css/app.css` | ブックカードCSS追加、ナビアイコンCSS追加 |
