# NekoLoto6 開発記録 — 2026年2月23日

## 概要

サイドバーに「今週の一冊」ブックウィジェット（Amazonアフィリエイト連携）を追加。
Claude API を使った週次自動選書システムも構築し、GitHub Actions で毎週月曜に自動更新される仕組みを完成させた。

---

## 実装内容

### 1. ブックウィジェットのUI実装

サイドバー下部に「📚 今週の一冊」ウィジェットを追加した。

#### 構成要素
- 書影画像（Amazon Product Image API）
- 書名・著者名
- 書店員風の紹介コメント（吹き出しPOP風）
- 「Amazonで見る →」リンクボタン（アフィリエイトタグ付き）

#### 追加・変更ファイル

| ファイル | 変更内容 |
|----------|----------|
| `wwwroot/js/book_widget.js` | 新規作成。`data/current_book.json` を fetch して DOM に反映。エラー時はウィジェット非表示 |
| `wwwroot/data/current_book.json` | 新規作成。表示する本の情報（title, author, asin, comment） |
| `wwwroot/css/app.css` | ブックウィジェット用CSS追加（ダークテーマに統一） |
| `tools/ScoreCalculator/HtmlGenerator.cs` | `GenerateSidebar()` にブックウィジェットHTML追加、`WrapPage()` に `book_widget.js` のscriptタグ追加 |
| `wwwroot/index.html` 他全5ページ | ScoreCalculator で再生成し、ブックウィジェットを含むHTMLに更新 |

#### デザインの経緯

1. 最初はライトテーマ（白背景 `#f9f7f2`）で作成
2. サイト全体のダークテーマと不一致だったため、rgba ベースの半透明ダークテーマに修正
3. レイアウトを横並び → 縦並び（画像中央揃え）に変更し、サイドバーの幅250pxに最適化

#### 最終的なCSS配色方針
- 背景: `rgba(255, 255, 255, 0.03)` — サイドバーに溶け込む微透過
- テキスト: `rgba(255, 255, 255, 0.35)` 〜 `rgba(255, 255, 255, 0.75)` — 控えめな階調
- 吹き出し: `rgba(255, 255, 255, 0.05)` + `rgba(255, 255, 255, 0.1)` ボーダー
- ボタン: `rgba(255, 255, 255, 0.15)` ボーダー、ホバーで `rgba(255, 255, 255, 0.08)` 背景

### 2. 週次自動選書システム（Claude API連携）

毎週月曜に Claude API が統計・確率関連の本を自動選書し、サイトに反映する仕組みを構築。

#### 新規ファイル

| ファイル | 役割 |
|----------|------|
| `scripts/update_book.py` | Claude API を呼び出して本を選書し、`current_book.json` を更新 |
| `.github/workflows/update-book.yml` | 毎週月曜 20:30 JST に自動実行。選書 → コミット → deploy.yml をトリガー |
| `wwwroot/data/book_history.json` | 過去に紹介した本の履歴（最大10冊）。重複選書を防止 |

#### update_book.py の仕組み

1. `book_history.json` から過去の紹介タイトルを読み込み
2. Claude API（claude-opus-4-6）にプロンプトを送信
   - 統計・確率・データ分析・数学的思考・行動経済学に関連する本を選書
   - 中年女性の書店員キャラクターで紹介コメントを生成（80〜120文字、POP風）
   - 過去に紹介した本は除外
   - ASINは実在するものを使用（不確かな場合は定番書籍を選択）
3. レスポンスのマークダウンコードブロックを除去してJSONパース
4. `current_book.json` を上書き、`book_history.json` に追記

#### update-book.yml ワークフロー

```
毎週月曜 20:30 JST（cron: '30 11 * * 1'）
  ↓
STEP 1: Python 3.12 + anthropic パッケージセットアップ
  ↓
STEP 2: update_book.py 実行（ANTHROPIC_API_KEY を secrets から取得）
  ↓
STEP 3: current_book.json + book_history.json をコミット＆プッシュ
  ↓
STEP 4: gh workflow run deploy.yml でデプロイをトリガー
```

#### 必要なGitHub設定
- リポジトリの Settings > Secrets に `ANTHROPIC_API_KEY` を登録済み
- permissions: `contents: write`（コミット用）、`actions: write`（deploy.yml トリガー用）

### 3. 書影画像URLの試行錯誤

Amazon の書影画像取得で複数のURLパターンを試した。

| 試行 | URL形式 | 結果 |
|------|---------|------|
| 1回目 | `images-amazon.com/images/P/{ASIN}.09.LZZZZZZZ.jpg` | 旧形式、多くの書籍で画像なし |
| 2回目 | `ws-fe.amazon-adsystem.com/widgets/q?...&ASIN={ASIN}` | PA-API不要だが表示不安定 |
| 3回目（最終） | `m.media-amazon.com/images/P/{ASIN}.01._SL160_.jpg` | 安定して表示される形式を採用 |

### 4. アフィリエイト構成

- Amazonアソシエイトタグ: `nekocode-22`
- リンク先URL: `https://www.amazon.co.jp/dp/{ASIN}/?tag=nekocode-22`
- 画像・書名クリック、「Amazonで見る →」ボタンの両方にアフィリエイトリンク設定

---

## HtmlGenerator.cs の変更詳細

### GenerateSidebar() メソッド

`</nav>` + `</div>`（nav-scrollable 閉じタグ）の直後に、ブックウィジェットのHTML（`<div class="book-widget">` 〜 `</div>`）を追加。全ページ共通のサイドバー生成メソッドなので、1箇所の修正で全5ページに反映される。

### WrapPage() メソッド

`</body>` 直前に `<script src="js/book_widget.js"></script>` を追加。

### 重要な注意点

- wwwroot の HTML を直接編集しても、次回 ScoreCalculator 実行時に上書きされる
- **恒久的な変更は必ず HtmlGenerator.cs に反映すること**
- HtmlGenerator.cs 修正後は ScoreCalculator を実行して HTML を再生成してからコミットする

---

## コミット履歴

| コミット | メッセージ |
|----------|-----------|
| `067a622` | Add weekly book auto-update workflow |
| `93a4dc9` | fix: strip markdown from Claude API response |
| `0a2b369` | fix: add write permission to update-book workflow |
| `21ac86d` | fix: add actions write permission to update-book workflow |
| `b6ebb04` | feat: add book widget to HtmlGenerator |
| `4480314` | feat: add book widget to HtmlGenerator（HTML再生成込み） |
| `269de5c` | fix: use Amazon adsystem URL for book cover image |
| `08fa743` | fix: correct book ASIN and improve prompt |
| `b6c6644` | fix: update book cover image URL |
| `cb7f3c7` | fix: book widget layout - vertical with centered image |

---

## 初回の選書

| 項目 | 内容 |
|------|------|
| 書名 | 統計学が最強の学問である |
| 著者 | 西内 啓 |
| ASIN | 4478022216 |
| コメント | 「数字って苦手で…」なんておっしゃらないで。この本、難しい数式は一切出てきません。読み終わったころには、ニュースや広告の見え方がきっと変わっていますよ。私のお気に入りの一冊です。 |

---

## ローカル確認手順（備忘録）

1. `npx serve` で `wwwroot` ディレクトリを配信（`dotnet run` はBlazorアプリを配信するため不可）
2. `<base href="/nekoloto6/">` を一時的に `<base href="/">` に変更
3. ブラウザで `http://localhost:5261` を確認
4. 確認後、base href を元に戻す → サーバー停止 → コミット＆プッシュ

**注意**: Python や未インストールのツールを勝手にインストールしないこと。Node.js（npx）はインストール済み。

---

## 現在のプロジェクト構成（追加分）

```
NekoLoto6/
├── .github/workflows/
│   ├── deploy.yml              ← push時の自動デプロイ
│   ├── update-loto6.yml        ← 月曜・木曜20:30 JSTの自動データ更新
│   └── update-book.yml         ← 【新規】毎週月曜20:30 JSTの選書更新
├── scripts/
│   ├── fetch-loto6-data.py     ← みずほ銀行からCSV取得
│   └── update_book.py          ← 【新規】Claude APIで選書・JSON更新
├── tools/ScoreCalculator/
│   ├── HtmlGenerator.cs        ← ブックウィジェットHTML生成を追加
│   └── ...
└── NekoLoto6.Client/wwwroot/
    ├── js/
    │   └── book_widget.js      ← 【新規】ブックウィジェットJS
    ├── data/
    │   ├── current_book.json   ← 【新規】現在表示中の本
    │   └── book_history.json   ← 【新規】過去の紹介履歴
    └── css/
        └── app.css             ← ブックウィジェットCSS追加
```
